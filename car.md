# 功能
在本节中，介绍需要实现的车的功能
## 概要
车的需要实现的功能为：寻黑线、红外避障、超声避障和可见光感应。各个功能互斥，即如果车当前在寻黑线功能时，红外避障和朝上避障不起作用，相应地，在红外避障功能下，寻黑线和超声也不起作用。各个功能的切换，由APP控制。
## 寻黑线
在寻黑线功能下，小车自动移动到在地面发现的黑线上，并沿着发现的黑线行驶，如果遇到”T“型线，则停在T型线处。如果小车没有发现黑线，则不动作。

小车所使用的黑线为普通黑色电工胶带所铺成，线宽度在30～50mm之间，T型终点的线的宽度在20～30mm之间，长度在100～180mm之间。黑线示例如下（除黑线宽度和T型终点外，无其他寸要求）：
![小车轨迹](http://www.pret-page.com/wp-content/uploads/2018/07/-1-e1531921582602.png)

## 红外避障
车通过车前方放置的红外对管实现红外避障。在红外避障的功能下，车没有给定的目的，即无目的地漫游。遇到障碍则躲避，没有障碍则直行。

## 超声避障
在超声避障功能下，车通过放置在180°舵机上的超声模块来实现避障。在该该功能下，车通过控制舵机，来使超声波模块扫面前方180°的障碍情况，并找出近距离内无障碍物的路线行驶。

## 可见光感应
在可见光感应功能下，车将跟随其发现的光斑移动。即使用手电筒照射地面，产生一个光斑，车即自转至正对光斑，然后移动到光斑所在的位置；如果车没有发现过半，则不移动。要求车可以感应的光斑的面积在0.3㎡以下。

## 参考
上述功能的实现，可以参考[这里](https://item.taobao.com/item.html?spm=allz0d.6639537.1997199601.489.79a27484Wich8d&id=41412918559)或[这里](https://item.taobao.com/item.html?spm=allz0d.6639537.1997199601.69.f8d9107FmfOhN&id=558364852908)
# 通信
## 基础
在系统（APP、过定位模块以及车，以下简称“系统”）中，所有的指令、消息等均使用WiFi发送，也就是说，系统的各个部分通过网络（局域网）来通信。


## 工作机制
车在启动后，首先检查网络连接，如果有网络链接，则开始每隔一秒广播自己的IP地址以及ID，即发送心跳包，并侦听本地的6875端口。在没有网络连接的情况下，车保持不动。
如果车在6875端口上发现了连接（此连接一定来自APP），那么就在6875端口上等待合法的指令。一旦发现了合法的指令，就执行之。

## 指令
在本系统中，所有的指令均以json形式发送，例如：
``` json
{
    “from” : ”192.168.1.3“,
    ”role“ : “app”,
    “mode” : “ir”,
    ”args“: ”none“
}
```
上面的指令的含义是开始红外避障模式。再如：
``` json
{
    "from" : "192.168.1.3",
    "role" : "app",
    "mode" : "rc",
    "args" : "{"x" : "0.1", "y" : "0.05", "z" : "0.0"}"
}
```
而这个指令则将车设置为遥控模式，并按照`x = 0.1, y = 0.05, z = 0.0`（见[移动](##移动)一节）的模式移动。

### 指令内容

- "from" : 发送指令的一方的ip地址，为字符串；
- "role" : 发送方的角色，默认保持为“app”，为字符串；
- "mode" : 要执行的功能，可以为"rc"、"ir"、"sonar"或"track"，分别表示“遥控”、“红外避障”、“超声避障”以及“黑线寻迹”。
- "args" : 指令的参数，除了"rc"模式需要有参数外，其他的mode均不需要参数（设置为"none"）。在“rc”mode下，args为一个嵌套的json，见[移动-格式](###格式)一节。所有的参数均为字符串。

## 心跳包
车在运行的过程中，需要在所在的局域网中广播自己的IP地址，以便APP和其他部分（光定位模块和其他车）能够寻找到自己。心跳白需要广播到7755端口。心跳包的格式如下：
``` json
{
    "id" : "<车的id，默认为1>",
    "role" : "car",
    "ip" : "<车的ip，在运行初期获取>",
}
```


## 移动
在本节中，只考虑车体坐标系。

车的坐标使用右手正交坐标系，Y轴正方向指向车头方向，X轴正方向指向车的正右方，Z轴垂直向上。在遥控功能下，APP将发送以x、y和z的值，来表示车向前、向右以及逆时针旋转（从车顶视角）的速度。
### 平移
x与y的值实际上是设移动方向矢量在x轴和y轴的投影值。例如：
>
>x = 0.707, y = 0.707
>
则表示车的移动方向为右前方45°，移动速度为满速度（10km/h）。再如：
>
> x = -0.433, y =-0.24
>
则表示车的移动方向为左后，与x轴夹角为30°，移动速度为满速度的一半。

亦即：argctan(y / x)为速度矢量与x轴的夹角，而sqrt(x^2 + y^2) × <满速度>则为世纪速度。

另外，车的速度控制为开环控制。

### 自转
车的自转的正方向为逆时针方向（从车顶视角）。例如：
>
> z = 0.3
>

则表示逆时针以30%最大自转速度自转。

>
> z = -0.1
>

则表示顺时针以10%最大自转速度自转。
**最大自转速度**:在最大自转速度设定为40%电机占空比下，右侧轮前向旋转（即右轮使车的右侧前移），左轮后向旋转（即左轮使车的左侧后移）时车的自转速度。
### 格式
``` json
{
    "from" : "192.168.1.3",
    "role" : "app",
    "mode" : "rc",
    "args" : "{"x" : "0.1", "y" : "0.05", "z" : "0.0"}"
}
```
注意，在遥控指令中，args中的内容为一个嵌套的json，格式如下
```
{
    "x" : "0.1",
    "y" : "0.05",
    "z" : "0.0"
}
## 功能切换
当APP发送一个新的指令时，如果新的指令的功能和当前执行的功能不同，则直接执行指令中的功能（即立即执行功能切换）。

## 各个功能的指令

### 红外避障
``` json
{
    "from" : "192.168.1.3",
    "role" : "app",
    "mode" : "ir",
    "args" : "none"
}
```
### 超声避障
``` json
{
    "from" : "192.168.1.3",
    "role" : "app",
    "mode" : "sonar",
    "args" : "none"
}
```
### 寻迹
``` json
{
    "from" : "192.168.1.3",
    "role" : "app",
    "mode" : "track",
    "args" : "none"
}
### 遥控
见[移动-格式](###格式)一节
